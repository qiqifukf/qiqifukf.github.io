<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>导航网站管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        // 配置Tailwind
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        danger: '#EF4444',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .form-input {
                @apply w-full px-4 py-2 rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none transition-all;
            }
            .btn {
                @apply px-4 py-2 rounded-lg font-medium transition-all;
            }
            .btn-primary {
                @apply bg-primary text-white hover:bg-primary/90 active:bg-primary/80;
            }
            .btn-secondary {
                @apply bg-gray-100 text-gray-700 hover:bg-gray-200 active:bg-gray-300;
            }
            .btn-danger {
                @apply bg-danger text-white hover:bg-danger/90 active:bg-danger/80;
            }
            .table-row-animate {
                @apply transition-all duration-200;
            }
            .fade-in {
                animation: fadeIn 0.3s ease-in-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">
    <!-- 顶部导航 -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-2">
                    <a href="index.html" class="flex items-center gap-2">
                        <i class="fa fa-compass text-primary text-2xl"></i>
                        <span class="text-xl font-bold">导航中心管理</span>
                    </a>
                </div>
                <div class="flex items-center gap-4">
                    <div class="hidden md:block">
                        <span class="text-sm text-gray-500">上次更新: <span id="last-update">从未</span></span>
                    </div>
                    <a href="index.html" class="flex items-center gap-1 px-3 py-1.5 rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 transition-all">
                        <i class="fa fa-home"></i>
                        <span>返回首页</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 py-6">
        <!-- 状态提示栏 -->
        <div id="status-bar" class="bg-blue-50 border border-blue-100 rounded-lg p-4 mb-6 hidden fade-in">
            <div class="flex items-start gap-3">
                <i class="fa fa-info-circle text-blue-500 mt-0.5"></i>
                <div class="flex-1">
                    <h3 class="font-medium text-blue-800">提示</h3>
                    <p class="text-sm text-blue-700 mt-1" id="status-message">所有更改会自动保存到本地</p>
                </div>
                <button id="close-status" class="text-blue-400 hover:text-blue-500">
                    <i class="fa fa-times"></i>
                </button>
            </div>
        </div>

        <!-- 管理标签页 -->
        <div class="mb-6 border-b border-gray-200">
            <div class="flex overflow-x-auto -mb-px">
                <button id="websites-tab" class="py-4 px-5 border-b-2 border-primary text-primary font-medium whitespace-nowrap">
                    <i class="fa fa-globe mr-2"></i>网站管理
                </button>
                <button id="categories-tab" class="py-4 px-5 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium whitespace-nowrap">
                    <i class="fa fa-folder mr-2"></i>分类管理
                </button>
                <button id="settings-tab" class="py-4 px-5 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium whitespace-nowrap">
                    <i class="fa fa-cog mr-2"></i>设置
                </button>
            </div>
        </div>

        <!-- 网站管理面板 -->
        <div id="websites-panel" class="space-y-6">
            <!-- 操作按钮和统计信息 -->
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">网站列表</h2>
                    <p class="text-sm text-gray-500 mt-1" id="websites-count">共 <span>0</span> 个网站</p>
                </div>
                <div class="flex gap-3 flex-wrap">
                    <button id="add-website-btn" class="btn btn-primary flex items-center gap-1">
                        <i class="fa fa-plus"></i>
                        <span>添加网站</span>
                    </button>
                    <div class="relative group">
                        <button class="btn btn-secondary flex items-center gap-1">
                            <i class="fa fa-cog"></i>
                            <span>批量操作</span>
                            <i class="fa fa-chevron-down text-xs ml-1"></i>
                        </button>
                        <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-10 hidden group-hover:block">
                            <button id="batch-delete" class="w-full text-left px-4 py-2 text-sm text-danger hover:bg-gray-100">
                                <i class="fa fa-trash mr-2"></i>删除选中项
                            </button>
                            <button id="batch-category" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fa fa-folder mr-2"></i>批量修改分类
                            </button>
                        </div>
                    </div>
                    <button id="import-websites-btn" class="btn btn-secondary flex items-center gap-1">
                        <i class="fa fa-upload"></i>
                        <span>导入</span>
                    </button>
                    <button id="export-websites-btn" class="btn btn-secondary flex items-center gap-1">
                        <i class="fa fa-download"></i>
                        <span>导出</span>
                    </button>
                </div>
            </div>

            <!-- 搜索和筛选 -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <input type="text" id="websites-search" placeholder="搜索网站名称或URL..." class="form-input">
                    </div>
                    <div class="w-full md:w-48">
                        <select id="category-filter" class="form-input">
                            <option value="">所有分类</option>
                            <!-- 分类选项将通过JS动态生成 -->
                        </select>
                    </div>
                    <div class="w-full md:w-auto self-end">
                        <button id="clear-filters" class="btn btn-secondary">
                            <i class="fa fa-refresh mr-1"></i>重置
                        </button>
                    </div>
                </div>
            </div>

            <!-- 网站列表表格 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">
                                <input type="checkbox" id="select-all" class="rounded border-gray-300 text-primary focus:ring-primary">
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">图标</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名称</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">URL</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分类</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">添加时间</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="websites-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- 网站数据将通过JS动态生成 -->
                    </tbody>
                </table>
                
                <!-- 空状态 -->
                <div id="websites-empty-state" class="py-16 text-center hidden">
                    <i class="fa fa-folder-open-o text-4xl text-gray-300 mb-3"></i>
                    <p class="text-gray-500">没有找到网站数据</p>
                    <button id="add-first-website" class="mt-4 btn btn-primary">
                        <i class="fa fa-plus mr-1"></i>添加第一个网站
                    </button>
                </div>

                <!-- 加载状态 -->
                <div id="websites-loading" class="py-16 text-center hidden">
                    <i class="fa fa-circle-o-notch fa-spin text-4xl text-gray-300 mb-3"></i>
                    <p class="text-gray-500">加载中...</p>
                </div>
            </div>
        </div>

        <!-- 分类管理面板 -->
        <div id="categories-panel" class="space-y-6 hidden">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">分类管理</h2>
                    <p class="text-sm text-gray-500 mt-1" id="categories-count">共 <span>0</span> 个分类</p>
                </div>
                <button id="add-category-btn" class="btn btn-primary flex items-center gap-1">
                    <i class="fa fa-plus"></i>
                    <span>添加分类</span>
                </button>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">图标</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分类名称</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">网站数量</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">占比</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="categories-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- 分类数据将通过JS动态生成 -->
                    </tbody>
                </table>
            </div>

            <!-- 分类统计图表 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">分类分布统计</h3>
                <div class="h-64">
                    <canvas id="categories-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- 设置面板 -->
        <div id="settings-panel" class="space-y-6 hidden">
            <h2 class="text-xl font-bold text-gray-800">系统设置</h2>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">网站设置</h3>
                
                <div class="space-y-4">
                    <div>
                        <label for="site-name" class="block text-sm font-medium text-gray-700 mb-1">网站名称</label>
                        <input type="text" id="site-name" value="导航中心" class="form-input">
                    </div>
                    
                    <div>
                        <label for="site-description" class="block text-sm font-medium text-gray-700 mb-1">网站描述</label>
                        <input type="text" id="site-description" value="简洁高效的网站导航" class="form-input">
                    </div>
                    
                    <div>
                        <label for="site-logo" class="block text-sm font-medium text-gray-700 mb-1">网站Logo URL</label>
                        <div class="flex gap-2">
                            <input type="url" id="site-logo" value="https://picsum.photos/48/48" class="form-input flex-1">
                            <button type="button" id="preview-logo" class="px-3 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50">
                                <i class="fa fa-eye"></i>
                            </button>
                        </div>
                        <div id="logo-preview-container" class="mt-2 hidden">
                            <img id="logo-preview" src="" alt="Logo预览" class="h-12 rounded-lg border border-gray-200">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">主题设置</label>
                        <div class="flex gap-4">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="theme" value="light" checked class="form-radio text-primary">
                                <span class="ml-2">浅色主题</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="theme" value="dark" class="form-radio text-primary">
                                <span class="ml-2">深色主题</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="theme" value="auto" class="form-radio text-primary">
                                <span class="ml-2">跟随系统</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <button id="save-settings" class="btn btn-primary">
                        <i class="fa fa-save mr-1"></i>保存设置
                    </button>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">数据管理</h3>
                
                <div class="space-y-4">
                    <div>
                        <button id="export-all-data" class="btn btn-secondary mr-3">
                            <i class="fa fa-download mr-1"></i>导出所有数据
                        </button>
                        <button id="import-all-data" class="btn btn-secondary mr-3">
                            <i class="fa fa-upload mr-1"></i>导入所有数据
                        </button>
                        <input type="file" id="import-file" accept=".json" class="hidden">
                    </div>
                    
                    <div class="border-t border-gray-200 pt-4">
                        <button id="backup-data" class="btn btn-secondary mr-3">
                            <i class="fa fa-database mr-1"></i>创建备份
                        </button>
                        <button id="restore-data" class="btn btn-secondary mr-3">
                            <i class="fa fa-undo mr-1"></i>恢复备份
                        </button>
                    </div>
                    
                    <div class="border-t border-gray-200 pt-4">
                        <button id="reset-to-defaults" class="btn btn-danger">
                            <i class="fa fa-refresh mr-1"></i>恢复默认数据
                        </button>
                        <p class="text-sm text-gray-500 mt-2">此操作将清除所有自定义数据，恢复到初始状态</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">关于</h3>
                <div class="space-y-3 text-sm text-gray-600">
                    <p>导航中心 v1.0.0</p>
                    <p>一个简洁高效的静态网站导航工具</p>
                    <p>所有数据存储在本地浏览器中，保护您的隐私</p>
                </div>
            </div>
        </div>
    </main>

    <!-- 添加/编辑网站模态框 -->
    <div id="website-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md mx-auto transform transition-all">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 id="website-modal-title" class="text-lg font-bold text-gray-800">添加网站</h3>
                    <button id="close-website-modal" class="text-gray-400 hover:text-gray-500">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-4">
                <form id="website-form">
                    <input type="hidden" id="website-id">
                    <input type="hidden" id="website-created-at">
                    
                    <div>
                        <label for="website-name" class="block text-sm font-medium text-gray-700 mb-1">网站名称 <span class="text-danger">*</span></label>
                        <input type="text" id="website-name" required class="form-input">
                    </div>
                    
                    <div>
                        <label for="website-url" class="block text-sm font-medium text-gray-700 mb-1">网站URL <span class="text-danger">*</span></label>
                        <input type="url" id="website-url" required placeholder="https://example.com" class="form-input">
                    </div>
                    
                    <div>
                        <label for="website-category" class="block text-sm font-medium text-gray-700 mb-1">分类 <span class="text-danger">*</span></label>
                        <select id="website-category" required class="form-input">
                            <!-- 分类选项将通过JS动态生成 -->
                        </select>
                    </div>
                    
                    <div>
                        <label for="website-icon" class="block text-sm font-medium text-gray-700 mb-1">图标URL (可选)</label>
                        <div class="flex gap-2">
                            <input type="url" id="website-icon" placeholder="https://example.com/icon.ico" class="form-input flex-1">
                            <button type="button" id="auto-fetch-icon" class="px-3 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50">
                                <i class="fa fa-magic"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">留空将自动获取网站favicon</p>
                        <div class="mt-2 flex items-center gap-2">
                            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center overflow-hidden">
                                <img id="icon-preview" src="https://picsum.photos/40/40" alt="图标预览" class="w-full h-full object-contain p-1">
                            </div>
                            <span class="text-xs text-gray-500">图标预览</span>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="p-4 flex justify-end gap-3 border-t border-gray-200">
                <button id="cancel-website" class="btn btn-secondary">取消</button>
                <button id="save-website" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>

    <!-- 批量修改分类模态框 -->
    <div id="batch-category-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md mx-auto transform transition-all">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-bold text-gray-800">批量修改分类</h3>
                    <button id="close-batch-category-modal" class="text-gray-400 hover:text-gray-500">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-4">
                <div>
                    <label for="batch-new-category" class="block text-sm font-medium text-gray-700 mb-1">目标分类 <span class="text-danger">*</span></label>
                    <select id="batch-new-category" required class="form-input">
                        <!-- 分类选项将通过JS动态生成 -->
                    </select>
                </div>
                
                <div class="bg-blue-50 p-3 rounded-lg text-sm text-blue-700">
                    <i class="fa fa-info-circle mr-1"></i>
                    <span id="batch-count-text">将把选中的 <span>0</span> 个网站修改为选中分类</span>
                </div>
            </div>
            
            <div class="p-4 flex justify-end gap-3 border-t border-gray-200">
                <button id="cancel-batch-category" class="btn btn-secondary">取消</button>
                <button id="confirm-batch-category" class="btn btn-primary">确认修改</button>
            </div>
        </div>
    </div>

    <!-- 添加/编辑分类模态框 -->
    <div id="category-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md mx-auto transform transition-all">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 id="category-modal-title" class="text-lg font-bold text-gray-800">添加分类</h3>
                    <button id="close-category-modal" class="text-gray-400 hover:text-gray-500">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-4">
                <form id="category-form">
                    <input type="hidden" id="category-id">
                    
                    <div>
                        <label for="category-name" class="block text-sm font-medium text-gray-700 mb-1">分类名称 <span class="text-danger">*</span></label>
                        <input type="text" id="category-name" required class="form-input">
                    </div>
                    
                    <div>
                        <label for="category-icon" class="block text-sm font-medium text-gray-700 mb-1">图标选择</label>
                        <div class="grid grid-cols-8 gap-2 p-2 border border-gray-200 rounded-lg">
                            <button type="button" class="category-icon-option w-10 h-10 flex items-center justify-center rounded hover:bg-gray-100" data-icon="fa-globe">
                                <i class="fa fa-globe"></i>
                            </button>
                            <button type="button" class="category-icon-option w-10 h-10 flex items-center justify-center rounded hover:bg-gray-100" data-icon="fa-search">
                                <i class="fa fa-search"></i>
                            </button>
                            <button type="button" class="category-icon-option w-10 h-10 flex items-center justify-center rounded hover:bg-gray-100" data-icon="fa-users">
                                <i class="fa fa-users"></i>
                            </button>
                            <button type="button" class="category-icon-option w-10 h-10 flex items-center justify-center rounded hover:bg-gray-100" data-icon="fa-play-circle">
                                <i class="fa fa-play-circle"></i>
                            </button>
                            <button type="button" class="category-icon-option w-10 h-10 flex items-center justify-center rounded hover:bg-gray-100" data-icon="fa-newspaper-o">
                                <i class="fa fa-newspaper-o"></i>
                            </button>
                            <button type="button" class="category-icon-option w-10 h-10 flex items-center justify-center rounded hover:bg-gray-100" data-icon="fa-shopping-cart">
                                <i class="fa fa-shopping-cart"></i>
                            </button>
                            <button type="button" class="category-icon-option w-10 h-10 flex items-center justify-center rounded hover:bg-gray-100" data-icon="fa-graduation-cap">
                                <i class="fa fa-graduation-cap"></i>
                            </button>
                            <button type="button" class="category-icon-option w-10 h-10 flex items-center justify-center rounded hover:bg-gray-100" data-icon="fa-gamepad">
                                <i class="fa fa-gamepad"></i>
                            </button>
                        </div>
                        <input type="hidden" id="category-icon" value="fa-globe">
                    </div>
                </form>
            </div>
            
            <div class="p-4 flex justify-end gap-3 border-t border-gray-200">
                <button id="cancel-category" class="btn btn-secondary">取消</button>
                <button id="save-category" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>

    <!-- 确认对话框 -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md mx-auto transform transition-all">
            <div class="p-6 border-b border-gray-200">
                <h3 id="confirm-title" class="text-lg font-bold text-gray-800">确认操作</h3>
            </div>
            
            <div class="p-6">
                <p id="confirm-message" class="text-gray-700">您确定要执行此操作吗？</p>
            </div>
            
            <div class="p-4 flex justify-end gap-3 border-t border-gray-200">
                <button id="confirm-cancel" class="btn btn-secondary">取消</button>
                <button id="confirm-ok" class="btn btn-danger">确认</button>
            </div>
        </div>
    </div>

    <!-- 通知提示 -->
    <div id="toast" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-2">
        <i id="toast-icon" class="fa fa-check-circle text-white"></i>
        <span id="toast-message" class="text-white font-medium"></span>
    </div>

    <!-- 引入Chart.js用于图表展示 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>

    <script>
        // 从localStorage获取网站数据
        function getWebsites() {
            const saved = localStorage.getItem('websites');
            return saved ? JSON.parse(saved) : [];
        }

        // 保存网站数据到localStorage
        function saveWebsites(websites) {
            localStorage.setItem('websites', JSON.stringify(websites));
            updateLastUpdateTime();
        }

        // 获取所有分类
        function getCategories() {
            const websites = getWebsites();
            return [...new Set(websites.map(website => website.category))];
        }

        // 获取分类对应的图标
        function getCategoryIcon(category) {
            // 从localStorage获取分类图标映射
            const categoryIcons = JSON.parse(localStorage.getItem('categoryIcons') || '{}');
            return categoryIcons[category] || 'fa-globe';
        }

        // 保存分类图标
        function saveCategoryIcon(category, icon) {
            const categoryIcons = JSON.parse(localStorage.getItem('categoryIcons') || '{}');
            categoryIcons[category] = icon;
            localStorage.setItem('categoryIcons', JSON.stringify(categoryIcons));
        }

        // 获取分类下的网站数量
        function getWebsiteCountByCategory(category) {
            const websites = getWebsites();
            return websites.filter(website => website.category === category).length;
        }

        // 渲染网站列表
        function renderWebsites(filteredWebsites = null) {
            showLoading('websites');
            
            // 使用setTimeout模拟加载过程，提升用户体验
            setTimeout(() => {
                const websites = filteredWebsites || getWebsites();
                const tableBody = document.getElementById('websites-table-body');
                const emptyState = document.getElementById('websites-empty-state');
                const websitesCount = document.getElementById('websites-count').querySelector('span');
                
                websitesCount.textContent = websites.length;
                
                if (websites.length === 0) {
                    tableBody.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    hideLoading('websites');
                    return;
                }
                
                emptyState.classList.add('hidden');
                tableBody.innerHTML = '';
                
                // 按添加时间排序，最新的在前
                const sortedWebsites = [...websites].sort((a, b) => 
                    new Date(b.createdAt || 0) - new Date(a.createdAt || 0)
                );
                
                sortedWebsites.forEach(website => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 transition-colors table-row-animate';
                    row.dataset.id = website.id;
                    
                    // 格式化日期
                    const date = website.createdAt ? new Date(website.createdAt) : new Date();
                    const formattedDate = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" class="website-select rounded border-gray-300 text-primary focus:ring-primary" data-id="${website.id}">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center overflow-hidden">
                                <img src="${website.icon || getFaviconUrl(website.url)}" alt="${website.name}图标" class="w-full h-full object-contain p-1"
                                    onerror="this.src='https://picsum.photos/32/32?random=${website.id}'">
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${website.name}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-500 truncate max-w-xs">${website.url}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                ${website.category}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${formattedDate}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="edit-website text-primary hover:text-primary/80 mr-3" data-id="${website.id}">
                                <i class="fa fa-pencil"></i> 编辑
                            </button>
                            <button class="delete-website text-danger hover:text-danger/80" data-id="${website.id}" data-name="${website.name}">
                                <i class="fa fa-trash"></i> 删除
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                // 绑定编辑和删除事件
                document.querySelectorAll('.edit-website').forEach(btn => {
                    btn.addEventListener('click', () => editWebsite(parseInt(btn.dataset.id)));
                });
                
                document.querySelectorAll('.delete-website').forEach(btn => {
                    btn.addEventListener('click', () => showDeleteConfirm(
                        parseInt(btn.dataset.id), 
                        btn.dataset.name
                    ));
                });
                
                // 绑定复选框事件
                document.querySelectorAll('.website-select').forEach(checkbox => {
                    checkbox.addEventListener('change', updateSelectAllStatus);
                });
                
                hideLoading('websites');
            }, 300);
        }

        // 显示加载状态
        function showLoading(panel) {
            if (panel === 'websites') {
                document.getElementById('websites-loading').classList.remove('hidden');
                document.getElementById('websites-table-body').classList.add('hidden');
                document.getElementById('websites-empty-state').classList.add('hidden');
            }
        }

        // 隐藏加载状态
        function hideLoading(panel) {
            if (panel === 'websites') {
                document.getElementById('websites-loading').classList.add('hidden');
                document.getElementById('websites-table-body').classList.remove('hidden');
            }
        }

        // 更新全选框状态
        function updateSelectAllStatus() {
            const checkboxes = document.querySelectorAll('.website-select');
            const checkedBoxes = document.querySelectorAll('.website-select:checked');
            const selectAll = document.getElementById('select-all');
            
            selectAll.checked = checkboxes.length > 0 && checkboxes.length === checkedBoxes.length;
        }

        // 全选/取消全选
        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('.website-select');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        // 获取选中的网站ID
        function getSelectedWebsiteIds() {
            const checkboxes = document.querySelectorAll('.website-select:checked');
            return Array.from(checkboxes).map(checkbox => parseInt(checkbox.dataset.id));
        }

        // 批量删除网站
        function batchDeleteWebsites() {
            const selectedIds = getSelectedWebsiteIds();
            
            if (selectedIds.length === 0) {
                showToast('请先选择要删除的网站', 'error');
                return;
            }
            
            document.getElementById('confirm-title').textContent = '批量删除网站';
            document.getElementById('confirm-message').textContent = `您确定要删除选中的${selectedIds.length}个网站吗？此操作不可撤销。`;
            
            const confirmOk = document.getElementById('confirm-ok');
            // 移除之前的事件监听器
            confirmOk.replaceWith(confirmOk.cloneNode(true));
            // 添加新的事件监听器
            document.getElementById('confirm-ok').addEventListener('click', () => {
                let websites = getWebsites();
                websites = websites.filter(website => !selectedIds.includes(website.id));
                saveWebsites(websites);
                
                renderWebsites();
                renderCategoryFilters();
                renderCategories();
                updateCategoryChart();
                
                closeConfirmModal();
                showToast(`已删除${selectedIds.length}个网站`);
            });
            
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        // 显示批量修改分类模态框
        function showBatchCategoryModal() {
            const selectedIds = getSelectedWebsiteIds();
            
            if (selectedIds.length === 0) {
                showToast('请先选择要修改的网站', 'error');
                return;
            }
            
            // 更新显示的选中数量
            document.getElementById('batch-count-text').querySelector('span').textContent = selectedIds.length;
            
            // 渲染分类选项
            renderBatchCategoryOptions();
            
            // 显示模态框
            document.getElementById('batch-category-modal').classList.remove('hidden');
        }

        // 渲染批量修改分类的选项
        function renderBatchCategoryOptions() {
            const categories = getCategories();
            const batchNewCategory = document.getElementById('batch-new-category');
            
            batchNewCategory.innerHTML = '';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                batchNewCategory.appendChild(option);
            });
        }

        // 确认批量修改分类
        function confirmBatchCategory() {
            const selectedIds = getSelectedWebsiteIds();
            const newCategory = document.getElementById('batch-new-category').value;
            
            if (!newCategory) {
                showToast('请选择目标分类', 'error');
                return;
            }
            
            let websites = getWebsites();
            websites = websites.map(website => {
                if (selectedIds.includes(website.id)) {
                    return { ...website, category: newCategory };
                }
                return website;
            });
            
            saveWebsites(websites);
            
            renderWebsites();
            renderCategoryFilters();
            renderCategories();
            updateCategoryChart();
            
            closeBatchCategoryModal();
            showToast(`已将${selectedIds.length}个网站修改为"${newCategory}"分类`);
        }

        // 关闭批量修改分类模态框
        function closeBatchCategoryModal() {
            document.getElementById('batch-category-modal').classList.add('hidden');
        }

        // 渲染分类过滤器
        function renderCategoryFilters() {
            const categories = getCategories();
            const categoryFilter = document.getElementById('category-filter');
            const websiteCategory = document.getElementById('website-category');
            
            // 保存当前选中值
            const currentFilterValue = categoryFilter.value;
            const currentWebsiteCategoryValue = websiteCategory.value;
            
            // 清空现有选项（保留第一个"所有分类"选项）
            while (categoryFilter.options.length > 1) {
                categoryFilter.remove(1);
            }
            websiteCategory.innerHTML = '';
            
            // 添加分类选项
            categories.forEach(category => {
                // 为过滤器添加选项
                const filterOption = document.createElement('option');
                filterOption.value = category;
                filterOption.textContent = category;
                categoryFilter.appendChild(filterOption);
                
                // 为网站表单添加选项
                const websiteOption = document.createElement('option');
                websiteOption.value = category;
                websiteOption.textContent = category;
                websiteCategory.appendChild(websiteOption);
            });
            
            // 恢复选中值
            if (currentFilterValue) {
                categoryFilter.value = currentFilterValue;
            }
            if (currentWebsiteCategoryValue) {
                websiteCategory.value = currentWebsiteCategoryValue;
            }
        }

        // 渲染分类列表
        function renderCategories() {
            const categories = getCategories();
            const tableBody = document.getElementById('categories-table-body');
            const categoriesCount = document.getElementById('categories-count').querySelector('span');
            const totalWebsites = getWebsites().length;
            
            categoriesCount.textContent = categories.length;
            tableBody.innerHTML = '';
            
            categories.forEach(category => {
                const count = getWebsiteCountByCategory(category);
                const percentage = totalWebsites > 0 ? Math.round((count / totalWebsites) * 100) : 0;
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                            <i class="fa ${getCategoryIcon(category)} text-gray-600"></i>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${category}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500">${count}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-24 bg-gray-200 rounded-full h-2">
                                <div class="bg-primary h-2 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                            <span class="ml-2 text-sm text-gray-500">${percentage}%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="edit-category text-primary hover:text-primary/80 mr-3" data-name="${category}">
                            <i class="fa fa-pencil"></i> 编辑
                        </button>
                        <button class="delete-category text-danger hover:text-danger/80" data-name="${category}">
                            <i class="fa fa-trash"></i> 删除
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // 绑定编辑和删除事件
            document.querySelectorAll('.edit-category').forEach(btn => {
                btn.addEventListener('click', () => editCategory(btn.dataset.name));
            });
            
            document.querySelectorAll('.delete-category').forEach(btn => {
                btn.addEventListener('click', () => showDeleteCategoryConfirm(btn.dataset.name));
            });
            
            // 更新图表
            updateCategoryChart();
        }

        // 更新分类统计图表
        function updateCategoryChart() {
            const ctx = document.getElementById('categories-chart');
            
            // 如果图表已存在，先销毁
            if (window.categoryChart) {
                window.categoryChart.destroy();
            }
            
            const categories = getCategories();
            const data = categories.map(category => getWebsiteCountByCategory(category));
            
            // 生成颜色数组
            const backgroundColors = categories.map((_, index) => {
                const hue = (index * 360 / categories.length) % 360;
                return `hsla(${hue}, 70%, 60%, 0.7)`;
            });
            
            // 创建图表
            window.categoryChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: categories,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 获取网站favicon URL
        function getFaviconUrl(url) {
            try {
                const parsedUrl = new URL(url);
                return `${parsedUrl.protocol}//${parsedUrl.hostname}/favicon.ico`;
            } catch (e) {
                return '';
            }
        }

        // 显示添加网站模态框
        function showAddWebsiteModal() {
            document.getElementById('website-modal-title').textContent = '添加网站';
            document.getElementById('website-form').reset();
            document.getElementById('website-id').value = '';
            document.getElementById('website-created-at').value = '';
            document.getElementById('icon-preview').src = 'https://picsum.photos/40/40';
            
            // 渲染分类选项
            renderCategoryFilters();
            
            document.getElementById('website-modal').classList.remove('hidden');
        }

        // 编辑网站
        function editWebsite(id) {
            const websites = getWebsites();
            const website = websites.find(w => w.id === id);
            
            if (!website) return;
            
            document.getElementById('website-modal-title').textContent = '编辑网站';
            document.getElementById('website-id').value = website.id;
            document.getElementById('website-name').value = website.name;
            document.getElementById('website-url').value = website.url;
            document.getElementById('website-created-at').value = website.createdAt || '';
            document.getElementById('website-icon').value = website.icon || '';
            
            // 更新图标预览
            document.getElementById('icon-preview').src = website.icon || getFaviconUrl(website.url) || 'https://picsum.photos/40/40';
            document.getElementById('icon-preview').onerror = function() {
                this.src = 'https://picsum.photos/40/40';
            };
            
            // 渲染分类选项
            renderCategoryFilters();
            // 设置选中的分类
            document.getElementById('website-category').value = website.category;
            
            document.getElementById('website-modal').classList.remove('hidden');
        }

        // 保存网站
        function saveWebsite() {
            const id = document.getElementById('website-id').value;
            const name = document.getElementById('website-name').value;
            let url = document.getElementById('website-url').value;
            const category = document.getElementById('website-category').value;
            let icon = document.getElementById('website-icon').value;
            const createdAt = document.getElementById('website-created-at').value;
            
            // 验证必填项
            if (!name || !url || !category) {
                showToast('请填写所有必填字段', 'error');
                return;
            }
            
            // 确保URL以http://或https://开头
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = `https://${url}`;
            }
            
            // 如果未提供图标，自动生成favicon URL
            if (!icon) {
                icon = getFaviconUrl(url);
            }
            
            const websites = getWebsites();
            let websiteData = {
                name,
                url,
                category,
                icon,
                createdAt: createdAt || new Date().toISOString()
            };
            
            if (id) {
                // 更新现有网站
                const index = websites.findIndex(w => w.id === parseInt(id));
                if (index !== -1) {
                    websiteData.id = parseInt(id);
                    websites[index] = websiteData;
                }
                showToast('网站已更新');
            } else {
                // 添加新网站
                websiteData.id = Date.now(); // 使用时间戳作为唯一ID
                websites.push(websiteData);
                showToast('网站已添加');
            }
            
            saveWebsites(websites);
            renderWebsites();
            renderCategoryFilters();
            renderCategories();
            closeWebsiteModal();
        }

        // 显示删除确认
        function showDeleteConfirm(id, name) {
            document.getElementById('confirm-title').textContent = '删除网站';
            document.getElementById('confirm-message').textContent = `您确定要删除"${name}"吗？此操作不可撤销。`;
            
            const confirmOk = document.getElementById('confirm-ok');
            // 移除之前的事件监听器
            confirmOk.replaceWith(confirmOk.cloneNode(true));
            // 添加新的事件监听器
            document.getElementById('confirm-ok').addEventListener('click', () => {
                deleteWebsite(id);
                closeConfirmModal();
            });
            
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        // 删除网站
        function deleteWebsite(id) {
            let websites = getWebsites();
            websites = websites.filter(website => website.id !== id);
            saveWebsites(websites);
            renderWebsites();
            renderCategories();
            updateCategoryChart();
            showToast('网站已删除');
        }

        // 关闭网站模态框
        function closeWebsiteModal() {
            document.getElementById('website-modal').classList.add('hidden');
        }

        // 关闭确认模态框
        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.add('hidden');
        }

        // 显示添加分类模态框
        function showAddCategoryModal() {
            document.getElementById('category-modal-title').textContent = '添加分类';
            document.getElementById('category-form').reset();
            document.getElementById('category-id').value = '';
            document.getElementById('category-icon').value = 'fa-globe';
            
            // 重置图标选择
            document.querySelectorAll('.category-icon-option').forEach(option => {
                option.classList.remove('bg-primary/10', 'text-primary');
            });
            document.querySelector(`.category-icon-option[data-icon="fa-globe"]`)
                .classList.add('bg-primary/10', 'text-primary');
            
            document.getElementById('category-modal').classList.remove('hidden');
        }

        // 编辑分类
        function editCategory(name) {
            document.getElementById('category-modal-title').textContent = '编辑分类';
            document.getElementById('category-name').value = name;
            document.getElementById('category-id').value = name; // 使用名称作为临时ID
            
            // 设置图标
            const icon = getCategoryIcon(name);
            document.getElementById('category-icon').value = icon;
            
            // 更新图标选择
            document.querySelectorAll('.category-icon-option').forEach(option => {
                option.classList.remove('bg-primary/10', 'text-primary');
                if (option.dataset.icon === icon) {
                    option.classList.add('bg-primary/10', 'text-primary');
                }
            });
            
            document.getElementById('category-modal').classList.remove('hidden');
        }

        // 保存分类
        function saveCategory() {
            const oldName = document.getElementById('category-id').value;
            const newName = document.getElementById('category-name').value;
            const icon = document.getElementById('category-icon').value;
            
            if (!newName) {
                showToast('请输入分类名称', 'error');
                return;
            }
            
            // 如果是新分类
            if (!oldName) {
                // 检查分类是否已存在
                const categories = getCategories();
                if (categories.includes(newName)) {
                    showToast('该分类已存在', 'error');
                    return;
                }
                
                // 保存分类图标
                saveCategoryIcon(newName, icon);
                showToast('分类已添加');
            } else if (oldName !== newName) {
                // 如果重命名了分类，更新所有使用该分类的网站
                let websites = getWebsites();
                websites = websites.map(website => {
                    if (website.category === oldName) {
                        return { ...website, category: newName };
                    }
                    return website;
                });
                saveWebsites(websites);
                
                // 更新分类图标
                saveCategoryIcon(newName, icon);
                
                // 删除旧分类的图标设置
                const categoryIcons = JSON.parse(localStorage.getItem('categoryIcons') || '{}');
                delete categoryIcons[oldName];
                localStorage.setItem('categoryIcons', JSON.stringify(categoryIcons));
                
                showToast('分类已更新');
            } else {
                // 仅更新图标
                saveCategoryIcon(newName, icon);
                showToast('分类已更新');
            }
            
            renderCategories();
            renderCategoryFilters();
            renderWebsites();
            closeCategoryModal();
        }

        // 显示删除分类确认
        function showDeleteCategoryConfirm(name) {
            const websiteCount = getWebsiteCountByCategory(name);
            let message = `您确定要删除分类"${name}"吗？`;
            
            if (websiteCount > 0) {
                message += ` 该分类下有${websiteCount}个网站，它们将被移动到"未分类"。`;
            }
            
            document.getElementById('confirm-title').textContent = '删除分类';
            document.getElementById('confirm-message').textContent = message;
            
            const confirmOk = document.getElementById('confirm-ok');
            // 移除之前的事件监听器
            confirmOk.replaceWith(confirmOk.cloneNode(true));
            // 添加新的事件监听器
            document.getElementById('confirm-ok').addEventListener('click', () => {
                deleteCategory(name);
                closeConfirmModal();
            });
            
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        // 删除分类
        function deleteCategory(name) {
            // 更新使用该分类的网站
            let websites = getWebsites();
            websites = websites.map(website => {
                if (website.category === name) {
                    return { ...website, category: '未分类' };
                }
                return website;
            });
            saveWebsites(websites);
            
            // 删除分类图标设置
            const categoryIcons = JSON.parse(localStorage.getItem('categoryIcons') || '{}');
            delete categoryIcons[name];
            localStorage.setItem('categoryIcons', JSON.stringify(categoryIcons));
            
            renderCategories();
            renderCategoryFilters();
            renderWebsites();
            updateCategoryChart();
            showToast('分类已删除');
        }

        // 关闭分类模态框
        function closeCategoryModal() {
            document.getElementById('category-modal').classList.add('hidden');
        }

        // 显示提示消息
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toast-icon');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            
            // 设置图标和背景色
            if (type === 'success') {
                toast.className = 'fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-2 bg-green-500';
                toastIcon.className = 'fa fa-check-circle text-white';
            } else if (type === 'error') {
                toast.className = 'fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-2 bg-red-500';
                toastIcon.className = 'fa fa-exclamation-circle text-white';
            } else if (type === 'info') {
                toast.className = 'fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-2 bg-blue-500';
                toastIcon.className = 'fa fa-info-circle text-white';
            }
            
            // 显示提示
            setTimeout(() => {
                toast.classList.remove('translate-y-20', 'opacity-0');
            }, 10);
            
            // 3秒后隐藏
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // 切换标签页
        function switchTab(tabId) {
            // 隐藏所有面板
            document.getElementById('websites-panel').classList.add('hidden');
            document.getElementById('categories-panel').classList.add('hidden');
            document.getElementById('settings-panel').classList.add('hidden');
            
            // 移除所有标签的活跃状态
            document.getElementById('websites-tab').classList.remove('border-primary', 'text-primary');
            document.getElementById('categories-tab').classList.remove('border-primary', 'text-primary');
            document.getElementById('settings-tab').classList.remove('border-primary', 'text-primary');
            
            document.getElementById('websites-tab').classList.add('border-transparent', 'text-gray-500');
            document.getElementById('categories-tab').classList.add('border-transparent', 'text-gray-500');
            document.getElementById('settings-tab').classList.add('border-transparent', 'text-gray-500');
            
            // 显示选中的面板和标签
            document.getElementById(`${tabId}-panel`).classList.remove('hidden');
            document.getElementById(`${tabId}-tab`).classList.remove('border-transparent', 'text-gray-500');
            document.getElementById(`${tabId}-tab`).classList.add('border-primary', 'text-primary');
            
            // 如果切换到分类面板，确保图表已初始化
            if (tabId === 'categories' && typeof Chart !== 'undefined') {
                updateCategoryChart();
            }
        }

        // 过滤网站
        function filterWebsites() {
            const searchTerm = document.getElementById('websites-search').value.toLowerCase();
            const categoryFilter = document.getElementById('category-filter').value;
            
            let websites = getWebsites();
            
            // 搜索过滤
            if (searchTerm) {
                websites = websites.filter(website => 
                    website.name.toLowerCase().includes(searchTerm) || 
                    website.url.toLowerCase().includes(searchTerm) ||
                    website.category.toLowerCase().includes(searchTerm)
                );
            }
            
            // 分类过滤
            if (categoryFilter) {
                websites = websites.filter(website => website.category === categoryFilter);
            }
            
            renderWebsites(websites);
        }

        // 清空过滤器
        function clearFilters() {
            document.getElementById('websites-search').value = '';
            document.getElementById('category-filter').value = '';
            renderWebsites();
        }

        // 导出网站数据
        function exportWebsites() {
            const websites = getWebsites();
            const dataStr = JSON.stringify(websites, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'websites_' + new Date().toISOString().slice(0,10) + '.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('网站数据已导出');
        }

        // 导入网站数据
        function importWebsites() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const websites = JSON.parse(event.target.result);
                        if (Array.isArray(websites)) {
                            // 为没有ID的网站添加ID
                            const websitesWithIds = websites.map(website => {
                                if (!website.id) {
                                    return { ...website, id: Date.now() + Math.floor(Math.random() * 1000), createdAt: website.createdAt || new Date().toISOString() };
                                }
                                return website;
                            });
                            
                            saveWebsites(websitesWithIds);
                            renderWebsites();
                            renderCategoryFilters();
                            renderCategories();
                            updateCategoryChart();
                            showToast('网站数据已导入');
                        } else {
                            showToast('导入的数据格式不正确', 'error');
                        }
                    } catch (error) {
                        showToast('导入失败：' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // 保存设置
        function saveSettings() {
            const siteName = document.getElementById('site-name').value;
            const siteDescription = document.getElementById('site-description').value;
            const siteLogo = document.getElementById('site-logo').value;
            const theme = document.querySelector('input[name="theme"]:checked').value;
            
            const settings = {
                siteName,
                siteDescription,
                siteLogo,
                theme,
                updatedAt: new Date().toISOString()
            };
            
            localStorage.setItem('settings', JSON.stringify(settings));
            showToast('设置已保存');
            
            // 应用主题设置
            applyTheme(theme);
        }

        // 应用主题
        function applyTheme(theme) {
            // 移除所有主题类
            document.documentElement.classList.remove('dark', 'light');
            
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else if (theme === 'light') {
                document.documentElement.classList.add('light');
            } else {
                // 跟随系统
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.add('light');
                }
            }
        }

        // 加载设置
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('settings') || '{}');
            
            if (settings.siteName) {
                document.getElementById('site-name').value = settings.siteName;
            }
            if (settings.siteDescription) {
                document.getElementById('site-description').value = settings.siteDescription;
            }
            if (settings.siteLogo) {
                document.getElementById('site-logo').value = settings.siteLogo;
            }
            if (settings.theme) {
                document.querySelector(`input[name="theme"][value="${settings.theme}"]`).checked = true;
                applyTheme(settings.theme);
            }
        }

        // 预览Logo
        function previewLogo() {
            const logoUrl = document.getElementById('site-logo').value;
            const previewContainer = document.getElementById('logo-preview-container');
            const previewImage = document.getElementById('logo-preview');
            
            if (logoUrl) {
                previewImage.src = logoUrl;
                previewImage.onerror = function() {
                    this.src = 'https://picsum.photos/48/48';
                    showToast('无法加载Logo图片', 'error');
                };
                previewContainer.classList.remove('hidden');
            } else {
                previewContainer.classList.add('hidden');
                showToast('请输入Logo URL', 'info');
            }
        }

        // 导出所有数据
        function exportAllData() {
            const websites = getWebsites();
            const categoryIcons = JSON.parse(localStorage.getItem('categoryIcons') || '{}');
            const settings = JSON.parse(localStorage.getItem('settings') || '{}');
            
            const allData = {
                websites,
                categoryIcons,
                settings,
                exportedAt: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'navigation_data_' + new Date().toISOString().slice(0,10) + '.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('所有数据已导出');
        }

        // 导入所有数据
        function importAllData() {
            document.getElementById('import-file').click();
        }

        // 处理导入文件
        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showLoading('websites');
            
            const reader = new FileReader();
            reader.onload = event => {
                try {
                    const allData = JSON.parse(event.target.result);
                    
                    if (allData.websites) {
                        saveWebsites(allData.websites);
                    }
                    
                    if (allData.categoryIcons) {
                        localStorage.setItem('categoryIcons', JSON.stringify(allData.categoryIcons));
                    }
                    
                    if (allData.settings) {
                        localStorage.setItem('settings', JSON.stringify(allData.settings));
                        loadSettings();
                    }
                    
                    renderWebsites();
                    renderCategoryFilters();
                    renderCategories();
                    updateCategoryChart();
                    showToast('所有数据已导入');
                } catch (error) {
                    showToast('导入失败：' + error.message, 'error');
                } finally {
                    hideLoading('websites');
                }
            };
            reader.readAsText(file);
            
            // 重置文件输入，允许重复选择同一个文件
            event.target.value = '';
        }

        // 创建备份
        function createBackup() {
            const websites = getWebsites();
            const categoryIcons = JSON.parse(localStorage.getItem('categoryIcons') || '{}');
            const settings = JSON.parse(localStorage.getItem('settings') || '{}');
            
            const backup = {
                websites,
                categoryIcons,
                settings,
                backupAt: new Date().toISOString()
            };
            
            localStorage.setItem('backup', JSON.stringify(backup));
            showToast('备份已创建');
        }

        // 恢复备份
        function restoreBackup() {
            const backup = JSON.parse(localStorage.getItem('backup') || 'null');
            
            if (!backup) {
                showToast('没有找到备份数据', 'error');
                return;
            }
            
            document.getElementById('confirm-title').textContent = '恢复备份';
            document.getElementById('confirm-message').textContent = '此操作将用备份数据覆盖当前数据，是否继续？';
            
            const confirmOk = document.getElementById('confirm-ok');
            // 移除之前的事件监听器
            confirmOk.replaceWith(confirmOk.cloneNode(true));
            // 添加新的事件监听器
            document.getElementById('confirm-ok').addEventListener('click', () => {
                if (backup.websites) {
                    saveWebsites(backup.websites);
                }
                
                if (backup.categoryIcons) {
                    localStorage.setItem('categoryIcons', JSON.stringify(backup.categoryIcons));
                }
                
                if (backup.settings) {
                    localStorage.setItem('settings', JSON.stringify(backup.settings));
                    loadSettings();
                }
                
                renderWebsites();
                renderCategoryFilters();
                renderCategories();
                updateCategoryChart();
                
                closeConfirmModal();
                showToast('已从备份恢复数据');
            });
            
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        // 恢复默认数据
        function resetToDefaults() {
            document.getElementById('confirm-title').textContent = '恢复默认数据';
            document.getElementById('confirm-message').textContent = '此操作将清除所有自定义数据，恢复到初始状态。您确定要继续吗？';
            
            const confirmOk = document.getElementById('confirm-ok');
            // 移除之前的事件监听器
            confirmOk.replaceWith(confirmOk.cloneNode(true));
            // 添加新的事件监听器
            document.getElementById('confirm-ok').addEventListener('click', () => {
                showLoading('websites');
                
                setTimeout(() => {
                    // 清除localStorage
                    localStorage.removeItem('websites');
                    localStorage.removeItem('categoryIcons');
                    localStorage.removeItem('settings');
                    
                    // 重新初始化
                    initDefaultData();
                    renderWebsites();
                    renderCategoryFilters();
                    renderCategories();
                    updateCategoryChart();
                    loadSettings();
                    
                    closeConfirmModal();
                    showToast('已恢复默认数据');
                    hideLoading('websites');
                }, 500);
            });
            
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        // 初始化默认数据
        function initDefaultData() {
            // 默认网站数据
            const defaultWebsites = [
                // 搜索引擎
                { id: 1, name: 'Google', url: 'https://google.com', category: '搜索引擎', icon: 'https://www.google.com/favicon.ico', createdAt: new Date().toISOString() },
                { id: 2, name: 'Bing', url: 'https://bing.com', category: '搜索引擎', icon: 'https://www.bing.com/favicon.ico', createdAt: new Date().toISOString() },
                { id: 3, name: 'Yahoo', url: 'https://yahoo.com', category: '搜索引擎', icon: 'https://www.yahoo.com/favicon.ico', createdAt: new Date().toISOString() },
                { id: 4, name: 'DuckDuckGo', url: 'https://duckduckgo.com', category: '搜索引擎', icon: 'https://duckduckgo.com/favicon.ico', createdAt: new Date().toISOString() },
                { id: 5, name: '百度', url: 'https://baidu.com', category: '搜索引擎', icon: 'https://www.baidu.com/favicon.ico', createdAt: new Date().toISOString() },
                
                // 社交媒体
                { id: 6, name: 'Facebook', url: 'https://facebook.com', category: '社交媒体', icon: 'https://www.facebook.com/favicon.ico', createdAt: new Date().toISOString() },
                { id: 7, name: 'Twitter', url: 'https://twitter.com', category: '社交媒体', icon: 'https://twitter.com/favicon.ico', createdAt: new Date().toISOString() },
                { id: 8, name: 'Instagram', url: 'https://instagram.com', category: '社交媒体', icon: 'https://www.instagram.com/favicon.ico', createdAt: new Date().toISOString() },
                { id: 9, name: 'LinkedIn', url: 'https://linkedin.com', category: '社交媒体', icon: 'https://www.linkedin.com/favicon.ico', createdAt: new Date().toISOString() },
                { id: 10, name: 'Pinterest', url: 'https://pinterest.com', category: '社交媒体', icon: 'https://www.pinterest.com/favicon.ico', createdAt: new Date().toISOString() },
                
                // 视频平台
                { id: 11, name: 'YouTube', url: 'https://youtube.com', category: '视频平台', icon: 'https://www.youtube.com/favicon.ico', createdAt: new Date().toISOString() },
                { id: 12, name: 'Netflix', url: 'https://netflix.com', category: '视频平台', icon: 'https://www.netflix.com/favicon.ico', createdAt: new Date().toISOString() },
                { id: 13, name: 'Hulu', url: 'https://hulu.com', category: '视频平台', icon: 'https://www.hulu.com/favicon.ico', createdAt: new Date().toISOString() },
                { id: 14, name: 'Disney+', url: 'https://disneyplus.com', category: '视频平台', icon: 'https://www.disneyplus.com/favicon.ico', createdAt: new Date().toISOString() },
                { id: 15, name: 'Vimeo', url: 'https://vimeo.com', category: '视频平台', icon: 'https://vimeo.com/favicon.ico', createdAt: new Date().toISOString() },
                
                // 新闻资讯
                { id: 16, name: 'CNN', url: 'https://cnn.com', category: '新闻资讯', icon: 'https://www.cnn.com/favicon.ico', createdAt: new Date().toISOString() },
                { id: 17, name: 'BBC News', url: 'https://bbc.com/news', category: '新闻资讯', icon: 'https://www.bbc.com/favicon.ico', createdAt: new Date().toISOString() },
                { id: 18, name: '纽约时报', url: 'https://nytimes.com', category: '新闻资讯', icon: 'https://www.nytimes.com/favicon.ico', createdAt: new Date().toISOString() },
                { id: 19, name: '路透社', url: 'https://reuters.com', category: '新闻资讯', icon: 'https://www.reuters.com/favicon.ico', createdAt: new Date().toISOString() },
                { id: 20, name: '美联社', url: 'https://apnews.com', category: '新闻资讯', icon: 'https://apnews.com/favicon.ico', createdAt: new Date().toISOString() },
                
                // 工具类
                { id: 21, name: 'GitHub', url: 'https://github.com', category: '工具类', icon: 'https://github.com/favicon.ico', createdAt: new Date().toISOString() },
                { id: 22, name: 'Stack Overflow', url: 'https://stackoverflow.com', category: '工具类', icon: 'https://stackoverflow.com/favicon.ico', createdAt: new Date().toISOString() },
                { id: 23, name: 'Google Maps', url: 'https://maps.google.com', category: '工具类', icon: 'https://maps.google.com/favicon.ico', createdAt: new Date().toISOString() },
                { id: 24, name: 'Dropbox', url: 'https://dropbox.com', category: '工具类', icon: 'https://www.dropbox.com/favicon.ico', createdAt: new Date().toISOString() },
                { id: 25, name: 'Trello', url: 'https://trello.com', category: '工具类', icon: 'https://trello.com/favicon.ico', createdAt: new Date().toISOString() },
                
                // 电商平台
                { id: 26, name: 'Amazon', url: 'https://amazon.com', category: '电商平台', icon: 'https://www.amazon.com/favicon.ico', createdAt: new Date().toISOString() },
                { id: 27, name: 'eBay', url: 'https://ebay.com', category: '电商平台', icon: 'https://www.ebay.com/favicon.ico', createdAt: new Date().toISOString() },
                { id: 28, name: '阿里巴巴', url: 'https://alibaba.com', category: '电商平台', icon: 'https://www.alibaba.com/favicon.ico', createdAt: new Date().toISOString() },
                { id: 29, name: 'Shopify', url: 'https://shopify.com', category: '电商平台', icon: 'https://www.shopify.com/favicon.ico', createdAt: new Date().toISOString() },
                { id: 30, name: 'Etsy', url: 'https://etsy.com', category: '电商平台', icon: 'https://www.etsy.com/favicon.ico', createdAt: new Date().toISOString() }
            ];
            saveWebsites(defaultWebsites);
            
            // 设置默认分类图标
            const defaultCategoryIcons = {
                '搜索引擎': 'fa-search',
                '社交媒体': 'fa-users',
                '视频平台': 'fa-play-circle',
                '新闻资讯': 'fa-newspaper-o',
                '工具类': 'fa-wrench',
                '电商平台': 'fa-shopping-cart'
            };
            localStorage.setItem('categoryIcons', JSON.stringify(defaultCategoryIcons));
        }

        // 自动获取图标
        function autoFetchIcon() {
            const url = document.getElementById('website-url').value;
            if (!url) {
                showToast('请先输入网站URL', 'error');
                return;
            }
            
            try {
                const faviconUrl = getFaviconUrl(url);
                document.getElementById('website-icon').value = faviconUrl;
                
                // 更新图标预览
                document.getElementById('icon-preview').src = faviconUrl;
                document.getElementById('icon-preview').onerror = function() {
                    this.src = 'https://picsum.photos/40/40';
                    showToast('无法获取图标，将使用默认图标', 'info');
                };
                
                showToast('已自动获取图标URL', 'info');
            } catch (e) {
                showToast('无法解析URL', 'error');
            }
        }

        // 更新最后更新时间
        function updateLastUpdateTime() {
            const now = new Date();
            const formattedTime = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            document.getElementById('last-update').textContent = formattedTime;
            
            // 保存最后更新时间
            localStorage.setItem('lastUpdate', formattedTime);
        }

        // 加载最后更新时间
        function loadLastUpdateTime() {
            const lastUpdate = localStorage.getItem('lastUpdate');
            if (lastUpdate) {
                document.getElementById('last-update').textContent = lastUpdate;
            }
        }

        // 初始化页面
        function init() {
            // 初始化数据（如果为空）
            if (!localStorage.getItem('websites')) {
                initDefaultData();
            }
            
            // 渲染页面
            renderWebsites();
            renderCategoryFilters();
            renderCategories();
            loadSettings();
            loadLastUpdateTime();
            
            // 显示状态提示
            setTimeout(() => {
                document.getElementById('status-bar').classList.remove('hidden');
            }, 500);
            
            // 绑定事件
            document.getElementById('websites-tab').addEventListener('click', () => switchTab('websites'));
            document.getElementById('categories-tab').addEventListener('click', () => switchTab('categories'));
            document.getElementById('settings-tab').addEventListener('click', () => switchTab('settings'));
            
            document.getElementById('add-website-btn').addEventListener('click', showAddWebsiteModal);
            document.getElementById('add-first-website').addEventListener('click', showAddWebsiteModal);
            document.getElementById('close-website-modal').addEventListener('click', closeWebsiteModal);
            document.getElementById('cancel-website').addEventListener('click', closeWebsiteModal);
            document.getElementById('save-website').addEventListener('click', saveWebsite);
            document.getElementById('auto-fetch-icon').addEventListener('click', autoFetchIcon);
            
            document.getElementById('add-category-btn').addEventListener('click', showAddCategoryModal);
            document.getElementById('close-category-modal').addEventListener('click', closeCategoryModal);
            document.getElementById('cancel-category').addEventListener('click', closeCategoryModal);
            document.getElementById('save-category').addEventListener('click', saveCategory);
            
            document.getElementById('confirm-cancel').addEventListener('click', closeConfirmModal);
            
            document.getElementById('websites-search').addEventListener('input', filterWebsites);
            document.getElementById('category-filter').addEventListener('change', filterWebsites);
            document.getElementById('clear-filters').addEventListener('click', clearFilters);
            
            document.getElementById('export-websites-btn').addEventListener('click', exportWebsites);
            document.getElementById('import-websites-btn').addEventListener('click', importWebsites);
            
            document.getElementById('save-settings').addEventListener('click', saveSettings);
            document.getElementById('export-all-data').addEventListener('click', exportAllData);
            document.getElementById('import-all-data').addEventListener('click', importAllData);
            document.getElementById('import-file').addEventListener('change', handleImportFile);
            document.getElementById('reset-to-defaults').addEventListener('click', resetToDefaults);
            document.getElementById('backup-data').addEventListener('click', createBackup);
            document.getElementById('restore-data').addEventListener('click', restoreBackup);
            document.getElementById('preview-logo').addEventListener('click', previewLogo);
            
            // 关闭状态提示
            document.getElementById('close-status').addEventListener('click', () => {
                document.getElementById('status-bar').classList.add('hidden');
            });
            
            // 全选框事件
            document.getElementById('select-all').addEventListener('change', toggleSelectAll);
            
            // 批量操作事件
            document.getElementById('batch-delete').addEventListener('click', batchDeleteWebsites);
            document.getElementById('batch-category').addEventListener('click', showBatchCategoryModal);
            
            // 批量修改分类事件
            document.getElementById('close-batch-category-modal').addEventListener('click', closeBatchCategoryModal);
            document.getElementById('cancel-batch-category').addEventListener('click', closeBatchCategoryModal);
            document.getElementById('confirm-batch-category').addEventListener('click', confirmBatchCategory);
            
            // 绑定分类图标选择事件
            document.querySelectorAll('.category-icon-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.preventDefault();
                    const icon = option.dataset.icon;
                    
                    // 更新选中状态
                    document.querySelectorAll('.category-icon-option').forEach(opt => {
                        opt.classList.remove('bg-primary/10', 'text-primary');
                    });
                    option.classList.add('bg-primary/10', 'text-primary');
                    
                    // 保存选中的图标
                    document.getElementById('category-icon').value = icon;
                });
            });
            
            // 监听URL输入变化，自动更新图标预览
            document.getElementById('website-url').addEventListener('change', function() {
                if (this.value && !document.getElementById('website-icon').value) {
                    try {
                        const faviconUrl = getFaviconUrl(this.value);
                        document.getElementById('icon-preview').src = faviconUrl;
                        document.getElementById('icon-preview').onerror = function() {
                            this.src = 'https://picsum.photos/40/40';
                        };
                    } catch (e) {
                        // 忽略错误
                    }
                }
            });
            
            // 监听图标URL输入变化，更新预览
            document.getElementById('website-icon').addEventListener('change', function() {
                if (this.value) {
                    document.getElementById('icon-preview').src = this.value;
                    document.getElementById('icon-preview').onerror = function() {
                        this.src = 'https://picsum.photos/40/40';
                    };
                } else if (document.getElementById('website-url').value) {
                    try {
                        const faviconUrl = getFaviconUrl(document.getElementById('website-url').value);
                        document.getElementById('icon-preview').src = faviconUrl;
                    } catch (e) {
                        document.getElementById('icon-preview').src = 'https://picsum.photos/40/40';
                    }
                }
            });
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
